<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç›´æ’­å½•åˆ¶æ§åˆ¶å°</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue-icon.min.js"></script>

  <style>
    body {
      background-color: #f4f5f7;
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 10px rgba(0, 0, 0, 0.05);
      padding: 24px;
    }

    /* é¡¶éƒ¨å·¥å…·æ  */
    .top-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f2f3f5;
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 13px;
      color: #4e5969;
    }
    .stat-item { display: flex; align-items: center; gap: 4px; }
    .stat-num { font-weight: bold; color: #1d2129; }

    /* çŠ¶æ€æŒ‡ç¤ºåœ†ç‚¹ */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      background-color: #c9cdd4;
    }
    .status-dot.is-recording {
      background-color: #00b42a;
      box-shadow: 0 0 6px rgba(0, 180, 42, 0.4);
    }

    .live-link { color: #165dff; text-decoration: none; font-size: 13px; transition: color 0.2s; }
    .live-link:hover { color: #4080ff; text-decoration: underline; }

    .arco-table .arco-table-col-fixed-left-last::after,
    .arco-table .arco-table-col-fixed-right-first::after { box-shadow: none !important; display: none !important; }
  </style>
</head>
<body>
<div id="app">
  <div class="main-container">

    <div class="top-toolbar">
      <div class="toolbar-left">
        <a-input-search
                v-model="searchQuery"
                placeholder="æœç´¢ä¸»æ’­æˆ–é“¾æ¥ (Ctrl+F)"
                style="width: 240px; background-color: #f2f3f5; border: none;">
        </a-input-search>

        <a-input-group>
          <a-select v-model="form.platform" style="width: 120px; background-color: #f2f3f5; border: none;" placeholder="é€‰æ‹©å¹³å°">
            <a-option value="Douyin">æŠ–éŸ³ (Douyin)</a-option>
            <a-option value="Kuaishou">å¿«æ‰‹ (Kuaishou)</a-option>
            <a-option value="Soop">Soop</a-option>
          </a-select>
          <a-input v-model="form.url" placeholder="ç›´æ’­é—´é“¾æ¥ (http...)" style="width: 300px; background-color: #f2f3f5; border: none;" allow-clear @press-enter="handleAdd"></a-input>
        </a-input-group>

        <a-button type="primary" status="success" @click="handleAdd" :loading="adding">
          <template #icon><icon-plus></icon-plus></template> æ·»åŠ 
        </a-button>

        <a-button type="primary" status="warning" @click="showBatchModal = true">
          <template #icon><icon-copy></icon-copy></template> æ‰¹é‡
        </a-button>

        <a-button type="outline" @click="showSettingsModal = true" style="margin-left: auto;">
          <template #icon><icon-settings></icon-settings></template> è®¾ç½®
        </a-button>
      </div>

      <div class="toolbar-right">
        <div class="stat-item">
          <icon-menu></icon-menu> æ€»è®¡: <span class="stat-num">{{ tasks.length }}</span>
        </div>
        <div class="stat-item" style="color: #00b42a;">
          <icon-play-circle></icon-play-circle> ç›‘æ§ä¸­: <span class="stat-num">{{ activeCount }}</span>
        </div>
        <div class="stat-item" style="color: #f53f3f;">
          <icon-record></icon-record> å½“å‰å½•åˆ¶: <span class="stat-num">{{ recordingCount }}</span>
        </div>
      </div>
    </div>

    <a-table :data="paginatedTasks" :pagination="false" :bordered="false" stripe hoverable>
      <template #empty>
        <a-empty description="æš‚æ— ç›‘æ§ä»»åŠ¡ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ "></a-empty>
      </template>

      <template #columns>
        <a-table-column title="ä¸»æ’­åç§°" data-index="anchor_name" :width="180">
          <template #cell="{ record }">
            <span style="font-weight: 600; color: #1d2129;">{{ record.anchor_name }}</span>
            <div v-if="record.status === 'åˆå§‹åŒ–ä¸­' || record.anchor_name === record.room_id" style="color: #86909c; font-size: 12px; margin-top: 2px;">
              <icon-loading></icon-loading> ç­‰å¾…å¼•æ“æŠ“å–...
            </div>
          </template>
        </a-table-column>

        <a-table-column title="ç›´æ’­é“¾æ¥">
          <template #cell="{ record }">
            <a :href="getLiveUrl(record.platform, record.room_id)" target="_blank" class="live-link">
              {{ getLiveUrl(record.platform, record.room_id) }}
            </a>
          </template>
        </a-table-column>

        <a-table-column title="å½•åˆ¶çŠ¶æ€" :width="280">
          <template #cell="{ record }">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="status-dot" :class="{ 'is-recording': record.status === 'å½•åˆ¶ä¸­' }"></span>

              <span :style="{ color: record.status === 'å½•åˆ¶ä¸­' ? '#00b42a' : '#86909c' }">
                {{ record.status === 'å½•åˆ¶ä¸­' ? 'æ­£åœ¨å½•åˆ¶' : 'æœªåœ¨å½•åˆ¶' }}
              </span>

              <span v-if="record.status === 'å½•åˆ¶ä¸­'" style="font-size: 12px; color: #86909c;">
                (<span style="color: #165dff;">{{ record.duration }}</span> | <span style="color: #ff7d00;">{{ record.file_size }}</span>)
              </span>
            </div>
          </template>
        </a-table-column>

        <a-table-column title="ç›‘å¬çŠ¶æ€" :width="160">
          <template #cell="{ record }">
            <div style="display: flex; align-items: center; gap: 8px;">
              <a-switch
                      :model-value="!record.is_paused"
                      size="small"
                      :loading="record.switching"
                      @change="(val) => handleSwitch(val, record)">
              </a-switch>
              <span :style="{ fontSize: '13px', color: !record.is_paused ? '#165dff' : '#86909c' }">
                {{ !record.is_paused ? 'ç›‘æ§ä¸­' : 'å·²åœæ­¢' }}
              </span>
            </div>
          </template>
        </a-table-column>

        <a-table-column title="æ“ä½œ" align="center" :width="100">
          <template #cell="{ record }">
            <a-popconfirm content="ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ(æœ¬åœ°æ–‡ä»¶ä¸ä¼šä¸¢å¤±)" type="error" @ok="handleControl('delete', record)">
              <a-button type="text" status="danger" size="small">
                <template #icon><icon-delete></icon-delete></template> åˆ é™¤
              </a-button>
            </a-popconfirm>
          </template>
        </a-table-column>
      </template>
    </a-table>

    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
      <a-pagination
              v-model:current="currentPage"
              v-model:page-size="pageSize"
              :total="sortedTasks.length"
              show-total
              show-jumper
              show-page-size>
      </a-pagination>
    </div>
  </div>

  <a-modal v-model:visible="showSettingsModal" title="âš™ï¸ å…¨å±€è®¾ç½®ä¸éªŒè¯" :footer="false" width="600px">
    <a-tabs default-active-key="1">
      <a-tab-pane key="1" title="åŸºç¡€è®¾ç½®">
        <a-form layout="vertical" :model="settings" style="margin-top: 15px;">
          <a-form-item label="å½•åˆ¶ä¿å­˜è·¯å¾„" tooltip="æ”¯æŒç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼Œé»˜è®¤ ./downloads">
            <a-input v-model="settings.save_path" placeholder="./downloads"></a-input>
          </a-form-item>
          <a-form-item label="é»˜è®¤å½•åˆ¶ç”»è´¨">
            <a-select v-model="settings.quality">
              <a-option value="uhd">è“å…‰ / è¶…æ¸… (æœ€é«˜ç”»è´¨)</a-option>
              <a-option value="hd">é«˜æ¸…</a-option>
              <a-option value="sd">æ ‡æ¸…</a-option>
            </a-select>
          </a-form-item>
          <a-form-item label="è‡ªåŠ¨åˆ†ç‰‡æ—¶é•¿ (åˆ†é’Ÿ)" tooltip="è¾¾åˆ°æ—¶é—´åè‡ªåŠ¨åˆ†å‰²è§†é¢‘æ–‡ä»¶ï¼Œ0ä¸ºä¸é™åˆ¶">
            <a-input-number v-model="settings.segment_time" :min="0" :max="1440"></a-input-number>
          </a-form-item>
          <a-button type="primary" status="success" long @click="saveSettings" :loading="saving">ä¿å­˜åŸºç¡€è®¾ç½®</a-button>
        </a-form>
      </a-tab-pane>

      <a-tab-pane key="2" title="å¹³å° Cookie ç®¡ç†">
        <div style="color: #86909c; font-size: 12px; margin: 10px 0 15px;">è‹¥ç¨‹åºä¸€ç›´æ˜¾ç¤ºâ€œç­‰å¾…ä¸­â€æˆ–æŠ¥é”™ï¼Œè¯·æ›´æ–°æ­¤å¤„çš„æµè§ˆå™¨ Cookie è§£é™¤å¹³å°é£æ§ã€‚</div>
        <a-form layout="vertical" :model="cookies">
          <a-form-item label="æŠ–éŸ³ (Douyin) Cookie">
            <a-textarea v-model="cookies.douyin" placeholder="æŠ“å–æŠ–éŸ³ç½‘é¡µç‰ˆ Cookie" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="å¿«æ‰‹ (Kuaishou) Cookie">
            <a-textarea v-model="cookies.kuaishou" placeholder="æŠ“å–å¿«æ‰‹ç½‘é¡µç‰ˆ Cookie (é€‰å¡«)" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="Soop Cookie">
            <a-textarea v-model="cookies.soop" placeholder="æŠ“å– Soop ç½‘é¡µç‰ˆ Cookie" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-button type="primary" status="warning" long @click="saveCookies" :loading="savingCookies">çƒ­æ›´æ–° Cookie</a-button>
        </a-form>
      </a-tab-pane>
    </a-tabs>
  </a-modal>

  <a-modal v-model:visible="showBatchModal" title="ğŸ“‘ æ‰¹é‡æ·»åŠ ç›‘æ§ä»»åŠ¡" @ok="handleBatchAdd" :ok-loading="batchAdding">
    <div style="margin-bottom: 15px;">
      <a-select v-model="batchForm.platform" placeholder="è¯·é€‰æ‹©ç»Ÿä¸€çš„å¹³å°">
        <a-option value="Douyin">æŠ–éŸ³ (Douyin)</a-option>
        <a-option value="Kuaishou">å¿«æ‰‹ (Kuaishou)</a-option>
        <a-option value="Soop">Soop (AfreecaTV)</a-option>
      </a-select>
    </div>
    <a-textarea
            v-model="batchForm.urls"
            placeholder="è¯·è¾“å…¥ç›´æ’­é—´é“¾æ¥æˆ–çº¯æ•°å­—IDï¼Œè¯·ç¡®ä¿ã€ä¸€è¡Œä¸€ä¸ªã€‘&#10;ç¤ºä¾‹ï¼š&#10;https://live.douyin.com/123456&#10;84964967751"
            :auto-size="{minRows: 6, maxRows: 12}">
    </a-textarea>
  </a-modal>
</div>

<script>
  const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;

  const App = {
    setup() {
      // çŠ¶æ€å˜é‡
      const searchQuery = ref('');
      const showSettingsModal = ref(false);
      const showBatchModal = ref(false);

      const currentPage = ref(1);
      const pageSize = ref(10);

      const form = ref({ platform: 'Douyin', url: '' });
      const batchForm = ref({ platform: 'Douyin', urls: '' });
      const settings = ref({ quality: 'uhd', segment_time: 0, save_path: './downloads' });
      const cookies = ref({ douyin: '', kuaishou: '', soop: '' });
      const tasks = ref([]);

      const adding = ref(false);
      const batchAdding = ref(false);
      const saving = ref(false);
      const savingCookies = ref(false);
      let timer = null;

      // è®¡ç®—å±æ€§ï¼šæœç´¢ + ç½®é¡¶æ’åº
      const sortedTasks = computed(() => {
        let list = [...tasks.value];
        if (searchQuery.value) {
          const q = searchQuery.value.toLowerCase();
          list = list.filter(t =>
                  t.anchor_name.toLowerCase().includes(q) ||
                  t.room_id.toLowerCase().includes(q)
          );
        }
        list.sort((a, b) => {
          const isARecording = a.status === 'å½•åˆ¶ä¸­' ? 1 : 0;
          const isBRecording = b.status === 'å½•åˆ¶ä¸­' ? 1 : 0;
          return isBRecording - isARecording;
        });
        return list;
      });

      const paginatedTasks = computed(() => {
        const start = (currentPage.value - 1) * pageSize.value;
        const end = start + pageSize.value;
        return sortedTasks.value.slice(start, end);
      });

      watch(searchQuery, () => {
        currentPage.value = 1;
      });

      const activeCount = computed(() => tasks.value.filter(t => !t.is_paused).length);
      const recordingCount = computed(() => tasks.value.filter(t => t.status === 'å½•åˆ¶ä¸­').length);

      const getLiveUrl = (platform, roomId) => {
        if (platform === 'Douyin') return `https://live.douyin.com/${roomId}`;
        if (platform === 'Kuaishou') return `https://live.kuaishou.com/u/${roomId}`;
        if (platform === 'Soop') return `https://play.sooplive.co.kr/${roomId}`;
        return roomId;
      };

      const fetchConfigAndCookies = async () => {
        try {
          const res1 = await fetch('/api/config');
          const data1 = await res1.json();
          if (data1) {
            settings.value.quality = data1.quality || 'uhd';
            settings.value.segment_time = data1.segment_time || 0;
            settings.value.save_path = data1.save_path || './downloads';
          }
          const res2 = await fetch('/api/cookies');
          const data2 = await res2.json();
          if (data2) { cookies.value = data2; }
        } catch (e) { console.error("è·å–è®¾ç½®å¤±è´¥", e); }
      };

      const saveSettings = async () => {
        saving.value = true;
        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("åŸºç¡€è®¾ç½®å·²ä¿å­˜ç”Ÿæ•ˆï¼");
            showSettingsModal.value = false;
          }
        } catch (e) { ArcoVue.Message.error("ä¿å­˜å¤±è´¥"); }
        finally { saving.value = false; }
      };

      const saveCookies = async () => {
        savingCookies.value = true;
        try {
          const res = await fetch('/api/cookies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cookies.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("Cookieå·²çƒ­æ›´æ–°ï¼");
          }
        } catch (e) { ArcoVue.Message.error("Cookieæ›´æ–°å¤±è´¥"); }
        finally { savingCookies.value = false; }
      };

      const fetchStatus = async () => {
        try {
          const res = await fetch('/api/status');
          const data = await res.json();
          // ä¿®å¤ï¼šæ›´æ–°æ•°æ®æ—¶ä¿ç•™æ­£åœ¨åˆ‡æ¢çš„çŠ¶æ€ï¼Œé˜²æ­¢æŒ‰é’®é—ªçƒ
          const currentSwitching = {};
          tasks.value.forEach(t => { if(t.switching) currentSwitching[`${t.platform}_${t.room_id}`] = true; });

          tasks.value = (data || []).map(t => ({
            ...t,
            switching: !!currentSwitching[`${t.platform}_${t.room_id}`]
          }));
        } catch (e) {}
      };

      const handleAdd = async () => {
        if (!form.value.url.trim()) return ArcoVue.Message.warning("è¯·å¡«å†™ç›´æ’­é—´åœ°å€æˆ–ID");
        adding.value = true;
        try {
          const res = await fetch('/api/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(form.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("ä»»åŠ¡æ·»åŠ æˆåŠŸ");
            form.value.url = '';
            await fetchStatus();
          } else {
            ArcoVue.Message.error(data.msg || "æ·»åŠ å¤±è´¥");
          }
        } catch (e) { ArcoVue.Message.error("è¯·æ±‚å¤±è´¥"); }
        finally { adding.value = false; }
      };

      const handleBatchAdd = async (done) => {
        const lines = batchForm.value.urls.split('\n').map(l => l.trim()).filter(l => l !== '');
        if (lines.length === 0) {
          ArcoVue.Message.warning("å†…å®¹ä¸ºç©º");
          done(false); return;
        }
        batchAdding.value = true;
        let success = 0, fail = 0;
        for (const url of lines) {
          try {
            const res = await fetch('/api/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ platform: batchForm.value.platform, url: url })
            });
            const data = await res.json();
            if (data.code === 0) success++; else fail++;
          } catch (e) { fail++; }
        }
        batchAdding.value = false;
        if (fail === 0) {
          ArcoVue.Message.success(`æˆåŠŸæ‰¹é‡æ·»åŠ  ${success} ä¸ªä»»åŠ¡`);
          batchForm.value.urls = '';
          done(true);
        } else {
          ArcoVue.Message.warning(`æ·»åŠ å®Œæˆï¼ŒæˆåŠŸ ${success} ä¸ªï¼Œå¤±è´¥ ${fail} ä¸ª`);
          done(true);
        }
        await fetchStatus();
      };

      // ä¿®å¤ Switch å¼€å…³è§¦å‘é€»è¾‘
      const handleSwitch = async (checked, record) => {
        // 1. ç«‹å³é”å®šæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        record.switching = true;
        const action = checked ? 'resume' : 'pause';

        try {
          // 2. å‘é€è¯·æ±‚
          const success = await handleControl(action, record);
          if (success) {
            // 3. ä¹è§‚æ›´æ–°æœ¬åœ° UI çŠ¶æ€ï¼Œæ”¹å–„äº¤äº’æ„Ÿ
            record.is_paused = !checked;
          }
        } finally {
          // 4. è§£é”æŒ‰é’®
          record.switching = false;
        }
      };

      const handleControl = async (action, record) => {
        try {
          const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: action,
              platform: record.platform,
              room_id: record.room_id
            })
          });
          const data = await res.json();
          if (data.code === 0) {
            if (action === 'delete') ArcoVue.Message.success("ä»»åŠ¡å·²åˆ é™¤");
            // è¿™é‡Œä¸è°ƒç”¨ fetchStatusï¼Œäº¤ç»™ handleSwitch ç»Ÿä¸€å¤„ç†æˆ–ç­‰å¾…å®šæ—¶å™¨åˆ·æ–°
            return true;
          } else {
            ArcoVue.Message.error(data.msg || "æ“ä½œå¤±è´¥");
            return false;
          }
        } catch (e) {
          ArcoVue.Message.error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
          return false;
        }
      };

      onMounted(() => {
        fetchConfigAndCookies();
        fetchStatus();
        timer = setInterval(fetchStatus, 3000);
      });
      onUnmounted(() => { if (timer) clearInterval(timer); });

      return {
        searchQuery, showSettingsModal, showBatchModal,
        currentPage, pageSize, sortedTasks, paginatedTasks,
        form, batchForm, settings, cookies, tasks,
        activeCount, recordingCount, adding, batchAdding, saving, savingCookies,
        getLiveUrl, handleAdd, handleBatchAdd, saveSettings, saveCookies, handleControl, handleSwitch, fetchStatus
      };
    }
  };

  const app = createApp(App);
  app.use(ArcoVue);
  app.use(ArcoVueIcon);
  app.mount('#app');
</script>
</body>
</html>
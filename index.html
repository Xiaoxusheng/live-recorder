<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç›´æ’­å½•åˆ¶æ§åˆ¶å°</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue-icon.min.js"></script>

  <style>
    body {
      background-color: #f2f3f5;
      margin: 0;
      padding: 15px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      margin-bottom: 24px;
      text-align: center;
      color: #1d2129;
      font-size: 1.5rem;
    }
    .custom-card {
      margin-bottom: 20px;
      border-radius: 8px;
      /* å»æ‰å¡ç‰‡é˜´å½±ï¼Œæ”¹ç”¨æç»†è¾¹æ¡† */
      box-shadow: none;
      border: 1px solid #e5e6eb;
    }
    .responsive-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }
    .responsive-form .arco-form-item {
      margin-bottom: 0;
    }
    .full-width {
      flex: 1 1 200px;
    }
    .btn-wrap {
      flex: 0 0 auto;
    }

    /* å½»åº•å»é™¤è¡¨æ ¼ fixed å›ºå®šåˆ—äº§ç”Ÿçš„è¾¹ç¼˜é˜´å½± */
    .arco-table .arco-table-col-fixed-left-last::after,
    .arco-table .arco-table-col-fixed-right-first::after,
    .arco-table-th-fixed-left::after,
    .arco-table-td-fixed-left::after,
    .arco-table-th-fixed-right::after,
    .arco-table-td-fixed-right::after {
      box-shadow: none !important;
      display: none !important;
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .header { font-size: 1.25rem; }
      .responsive-form { flex-direction: column; align-items: stretch; }
      .btn-wrap { display: flex; flex-direction: column; }
      .btn-wrap .arco-btn { width: 100%; }
    }
  </style>
</head>
<body>
<div id="app" class="container">
  <h2 class="header">ğŸ“º è·¨å¹³å°ç›´æ’­è‡ªåŠ¨å½•åˆ¶æ§åˆ¶å°</h2>

  <a-card title="âš™ï¸ å…¨å±€è®¾ç½®ä¸ Cookie ç®¡ç†" class="custom-card">
    <a-tabs default-active-key="1">
      <a-tab-pane key="1" title="åŸºç¡€è®¾ç½®">
        <div class="responsive-form" style="margin-top: 10px;">
          <a-form-item label="å½•åˆ¶ä¿å­˜è·¯å¾„" tooltip="å¯ä»¥å¡«å†™ç»å¯¹è·¯å¾„(å¦‚ D:\video) æˆ–ç›¸å¯¹è·¯å¾„ï¼Œé»˜è®¤ ./downloads" class="full-width" style="flex-basis: 100%;">
            <a-input v-model="settings.save_path" placeholder="ä¾‹å¦‚: ./downloads"></a-input>
          </a-form-item>

          <a-form-item label="é»˜è®¤å½•åˆ¶ç”»è´¨" class="full-width">
            <a-select v-model="settings.quality" placeholder="é€‰æ‹©ç”»è´¨">
              <a-option value="uhd">è“å…‰ / è¶…æ¸… (æœ€é«˜ç”»è´¨)</a-option>
              <a-option value="hd">é«˜æ¸…</a-option>
              <a-option value="sd">æ ‡æ¸…</a-option>
            </a-select>
          </a-form-item>

          <a-form-item label="è‡ªåŠ¨åˆ†ç‰‡æ—¶é•¿ (åˆ†é’Ÿ)" tooltip="è¾¾åˆ°æ­¤æ—¶é—´åè‡ªåŠ¨åˆ†å‰²è§†é¢‘æ–‡ä»¶ï¼Œ0è¡¨ç¤ºä¸åˆ†å‰²" class="full-width">
            <a-input-number v-model="settings.segment_time" :min="0" :max="1440" placeholder="å¡«å†™åˆ†é’Ÿæ•°, 0ä¸ºä¸é™åˆ¶"></a-input-number>
          </a-form-item>

          <div class="btn-wrap">
            <a-button type="primary" status="success" @click="saveSettings" :loading="saving">
              <template #icon><icon-save /></template> ä¿å­˜åŸºç¡€è®¾ç½®
            </a-button>
          </div>
        </div>
      </a-tab-pane>

      <a-tab-pane key="2" title="èº«ä»½éªŒè¯ (Cookie)">
        <div style="margin-top: 10px; color: #86909c; font-size: 13px; margin-bottom: 15px;">
          å¦‚æœå‘ç°ç¨‹åºä¸€ç›´åœ¨ç›‘æ§ä½†å§‹ç»ˆæ— æ³•å¼€å§‹å½•åˆ¶ï¼Œå¯èƒ½æ˜¯ç”±äºå¹³å°é£æ§ï¼Œè¯·åœ¨æ­¤æ›´æ–°å¯¹åº”å¹³å°çš„æµè§ˆå™¨ Cookieã€‚
        </div>
        <a-form layout="vertical" :model="cookies">
          <a-form-item label="æŠ–éŸ³ (Douyin) Cookie">
            <a-textarea v-model="cookies.douyin" placeholder="å¡«å…¥ä»æµè§ˆå™¨æŠ“å–çš„æŠ–éŸ³ Cookieï¼Œå¯è§£å†³éªŒè¯ç é£æ§é—®é¢˜" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="å¿«æ‰‹ (Kuaishou) Cookie">
            <a-textarea v-model="cookies.kuaishou" placeholder="å¡«å…¥å¿«æ‰‹ Cookie (é€‰å¡«)" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="Soop Cookie">
            <a-textarea v-model="cookies.soop" placeholder="å¡«å…¥ Soop Cookie (ç”¨äºéœ€è¦ç™»å½•çš„ç‰¹å®šæˆ¿é—´)" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-button type="primary" status="warning" @click="saveCookies" :loading="savingCookies">
            <template #icon><icon-safe /></template> çƒ­æ›´æ–° Cookie (ç«‹å³ç”Ÿæ•ˆ)
          </a-button>
        </a-form>
      </a-tab-pane>
    </a-tabs>
  </a-card>

  <a-card title="â• æ·»åŠ æ–°ç›‘æ§ä»»åŠ¡" class="custom-card">
    <div class="responsive-form">
      <a-form-item label="ç›´æ’­å¹³å°">
        <a-select v-model="form.platform" placeholder="è¯·é€‰æ‹©å¹³å°">
          <a-option value="Douyin">æŠ–éŸ³ (Douyin)</a-option>
          <a-option value="Kuaishou">å¿«æ‰‹ (Kuaishou)</a-option>
          <a-option value="Soop">Soop (AfreecaTV)</a-option>
        </a-select>
      </a-form-item>

      <a-form-item label="ç›´æ’­é—´åœ°å€ / ä¸»æ’­ID" class="full-width">
        <a-input
                v-model="form.url"
                placeholder="æ”¯æŒç²˜è´´å®Œæ•´çš„ç½‘é¡µé•¿é“¾æ¥æˆ–çº¯æ•°å­—ID"
                allow-clear>
        </a-input>
      </a-form-item>

      <div class="btn-wrap">
        <a-button type="primary" @click="handleAdd" :loading="adding">
          <template #icon><icon-plus /></template> ç«‹å³æ·»åŠ 
        </a-button>
      </div>
    </div>
  </a-card>

  <a-card title="ğŸ“¡ å®æ—¶è¿è¡ŒçŠ¶æ€" class="custom-card">
    <template #extra>
      <a-button type="outline" @click="fetchStatus" size="small" shape="round">
        <template #icon><icon-refresh /></template> æ‰‹åŠ¨åˆ·æ–°
      </a-button>
    </template>

    <a-table :data="tasks" :pagination="false" :bordered="false" stripe :scroll="{ x: 1200 }">
      <template #empty>
        <a-empty description="æš‚æ— ç›‘æ§ä»»åŠ¡ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ "></a-empty>
      </template>

      <template #columns>
        <a-table-column title="å½“å‰çŠ¶æ€" data-index="status" :width="110" fixed="left">
          <template #cell="{ record }">
            <a-badge v-if="record.is_paused" status="normal" color="gray" text="å·²æš‚åœ"></a-badge>
            <a-badge v-else-if="record.status === 'å½•åˆ¶ä¸­'" status="success" :text="record.status"></a-badge>
            <a-badge v-else-if="record.status === 'ç›‘æ§ä¸­'" status="processing" :text="record.status"></a-badge>
            <a-badge v-else-if="record.status === 'åˆå§‹åŒ–ä¸­'" status="warning" :text="record.status"></a-badge>
            <a-badge v-else status="normal" :text="record.status"></a-badge>
          </template>
        </a-table-column>

        <a-table-column title="ä¸»æ’­åç§°" data-index="anchor_name" :width="160">
          <template #cell="{ record }">
            <span style="font-weight: 600; color: #1d2129; font-size: 1.1em;">{{ record.anchor_name }}</span>
          </template>
        </a-table-column>

        <a-table-column title="å¹³å°" data-index="platform" :width="90">
          <template #cell="{ record }">
            <a-tag v-if="record.platform === 'Douyin'" color="black" size="small">æŠ–éŸ³</a-tag>
            <a-tag v-else-if="record.platform === 'Kuaishou'" color="orange" size="small">å¿«æ‰‹</a-tag>
            <a-tag v-else-if="record.platform === 'Soop'" color="blue" size="small">Soop</a-tag>
            <a-tag v-else color="gray" size="small">{{ record.platform }}</a-tag>
          </template>
        </a-table-column>

        <a-table-column title="å½“å‰ç”»è´¨" data-index="quality" :width="100">
          <template #cell="{ record }">
            <a-tag v-if="record.quality === 'uhd'" color="purple" size="small" bordered>è“å…‰è¶…æ¸…</a-tag>
            <a-tag v-else-if="record.quality === 'hd'" color="arcoblue" size="small" bordered>é«˜æ¸…</a-tag>
            <a-tag v-else-if="record.quality === 'sd'" color="gray" size="small" bordered>æ ‡æ¸…</a-tag>
            <span v-else>-</span>
          </template>
        </a-table-column>

        <a-table-column title="æœ¬æ¬¡å½•åˆ¶æ—¶é•¿" data-index="duration" :width="130">
          <template #cell="{ record }">
            <span v-if="record.duration && record.duration !== '-'" style="color: #165dff; font-family: monospace; font-weight: bold;">
              <icon-clock-circle /> {{ record.duration }}
            </span>
            <span v-else style="color: #86909c;">-</span>
          </template>
        </a-table-column>

        <a-table-column title="æœ¬åœ°å ç”¨å¤§å°" data-index="file_size" :width="120">
          <template #cell="{ record }">
            <span v-if="record.file_size" style="font-weight: bold; color: #ff7d00;">
              <icon-storage /> {{ record.file_size }}
            </span>
            <span v-else style="color: #86909c;">-</span>
          </template>
        </a-table-column>

        <a-table-column title="æœ€ååŠ¨æ€æ—¶é—´" data-index="update_time" :width="180"></a-table-column>

        <a-table-column title="æ“ä½œ" align="center" :width="140" fixed="right">
          <template #cell="{ record }">
            <a-space>
              <a-button v-if="record.is_paused" type="primary" size="small" status="success" @click="handleControl('resume', record)">
                æ¢å¤
              </a-button>
              <a-button v-else type="primary" size="small" status="warning" @click="handleControl('pause', record)">
                æš‚åœ
              </a-button>

              <a-popconfirm content="ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªç›‘æ§ä»»åŠ¡å—ï¼Ÿ(å·²å½•åˆ¶æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤)" type="error" @ok="handleControl('delete', record)">
                <a-button type="primary" size="small" status="danger">
                  åˆ é™¤
                </a-button>
              </a-popconfirm>
            </a-space>
          </template>
        </a-table-column>
      </template>
    </a-table>
  </a-card>
</div>

<script>
  const { createApp, ref, onMounted, onUnmounted } = Vue;

  const App = {
    setup() {
      const form = ref({ platform: 'Douyin', url: '' });
      // ä¿å­˜è·¯å¾„é»˜è®¤ ./downloads
      const settings = ref({ quality: 'uhd', segment_time: 0, save_path: './downloads' });
      const cookies = ref({ douyin: '', kuaishou: '', soop: '' });
      const tasks = ref([]);

      const adding = ref(false);
      const saving = ref(false);
      const savingCookies = ref(false);
      let timer = null;

      // è·å–å…¨å±€è®¾ç½®ä¸ Cookie
      const fetchConfigAndCookies = async () => {
        try {
          const res1 = await fetch('/api/config');
          const data1 = await res1.json();
          if (data1) {
            settings.value.quality = data1.quality || 'uhd';
            settings.value.segment_time = data1.segment_time || 0;
            // å›æ˜¾ä¿å­˜è·¯å¾„
            settings.value.save_path = data1.save_path || './downloads';
          }
          const res2 = await fetch('/api/cookies');
          const data2 = await res2.json();
          if (data2) {
            cookies.value = data2;
          }
        } catch (e) { console.error("è·å–è®¾ç½®å¤±è´¥", e); }
      };

      // ä¿å­˜å…¨å±€è®¾ç½®
      const saveSettings = async () => {
        saving.value = true;
        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings.value)
          });
          const data = await res.json();
          if (data.code === 0) ArcoVue.Message.success("åŸºç¡€è®¾ç½®å·²ä¿å­˜ï¼Œå°†åœ¨ä¸‹æ¬¡é‡æ–°æ‹‰æµæ—¶ç”Ÿæ•ˆ");
        } catch (e) {
          ArcoVue.Message.error("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ç½‘ç»œ");
        } finally { saving.value = false; }
      };

      // ä¿å­˜æ›´æ–° Cookie
      const saveCookies = async () => {
        savingCookies.value = true;
        try {
          const res = await fetch('/api/cookies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cookies.value)
          });
          const data = await res.json();
          if (data.code === 0) ArcoVue.Message.success("Cookie æ›´æ–°æˆåŠŸï¼Œåå°ä»»åŠ¡å°†ç«‹å³é‡‡ç”¨æ–°èº«ä»½æŠ“å–");
        } catch (e) {
          ArcoVue.Message.error("Cookie æ›´æ–°å¤±è´¥");
        } finally { savingCookies.value = false; }
      };

      // è·å–åå°å®æ—¶çŠ¶æ€åˆ—è¡¨
      const fetchStatus = async () => {
        try {
          const res = await fetch('/api/status');
          const data = await res.json();
          tasks.value = data || [];
        } catch (e) { console.error("è·å–çŠ¶æ€å¤±è´¥", e); }
      };

      // æäº¤æ·»åŠ æ–°ä¸»æ’­ä»»åŠ¡
      const handleAdd = async () => {
        if (!form.value.url.trim()) return ArcoVue.Message.warning("è¯·å¡«å†™ç›´æ’­é—´åœ°å€æˆ–ID");
        adding.value = true;
        try {
          const res = await fetch('/api/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(form.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("æˆåŠŸæ·»åŠ ç›‘æ§ä»»åŠ¡ï¼");
            form.value.url = '';
            await fetchStatus();
          } else {
            ArcoVue.Message.error(data.msg || "æ·»åŠ å¤±è´¥");
          }
        } catch (e) {
          ArcoVue.Message.error("æ·»åŠ å¤±è´¥ï¼Œåç«¯æœåŠ¡å¯èƒ½æœªå“åº”");
        } finally { adding.value = false; }
      };

      // å¤„ç†æš‚åœã€æ¢å¤ã€åˆ é™¤ä»»åŠ¡æ“ä½œ
      const handleControl = async (action, record) => {
        try {
          const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: action,
              platform: record.platform,
              room_id: record.room_id
            })
          });
          const data = await res.json();
          if (data.code === 0) {
            if (action === 'delete') ArcoVue.Message.success("ä»»åŠ¡å·²åˆ é™¤");
            else if (action === 'pause') ArcoVue.Message.success("ä»»åŠ¡å·²æš‚åœ");
            else ArcoVue.Message.success("ä»»åŠ¡å·²æ¢å¤");
            // æ“ä½œæˆåŠŸåç«‹å³åˆ·æ–°çŠ¶æ€åˆ—è¡¨
            await fetchStatus();
          }
        } catch (e) {
          ArcoVue.Message.error("æ“ä½œè¯·æ±‚å¤±è´¥");
        }
      };

      onMounted(() => {
        fetchConfigAndCookies();
        fetchStatus();
        timer = setInterval(fetchStatus, 3000);
      });

      onUnmounted(() => { if (timer) clearInterval(timer); });

      return {
        form, settings, cookies, tasks, adding, saving, savingCookies,
        fetchStatus, handleAdd, saveSettings, saveCookies, handleControl
      };
    }
  };

  const app = createApp(App);
  app.use(ArcoVue);
  app.use(ArcoVueIcon);
  app.mount('#app');
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2222%22 fill=%22%23165dff%22/><path d=%22M38 32 L72 50 L38 68 Z%22 fill=%22%23fff%22/></svg>">
  <title>ç›´æ’­å½•åˆ¶æ§åˆ¶å°</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@arco-design/web-vue@2.43.0/dist/arco-vue-icon.min.js"></script>

  <style>
    body {
      background-color: #f4f5f7;
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-image: radial-gradient(#e5e6eb 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
      padding: 16px 24px;
    }

    .top-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(229, 230, 235, 0.5);
    }
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: #4e5969;
    }
    .stat-item { display: flex; align-items: center; gap: 4px; }
    .stat-num { font-weight: bold; color: #1d2129; }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      background-color: #c9cdd4;
    }
    .status-dot.is-recording {
      background-color: #00b42a;
      box-shadow: 0 0 6px rgba(0, 180, 42, 0.4);
    }

    .live-link { color: #165dff; text-decoration: none; font-size: 12px; transition: color 0.2s; }
    .live-link:hover { color: #4080ff; text-decoration: underline; }

    .arco-table .arco-table-col-fixed-left-last::after,
    .arco-table .arco-table-col-fixed-right-first::after { box-shadow: none !important; display: none !important; }

    /* ç§»åŠ¨ç«¯æ ·å¼é€‚é… */
    @media screen and (max-width: 768px) {
      body { padding: 8px; }
      .main-container { padding: 12px; }
      .top-toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left { flex-wrap: wrap; gap: 8px; }
      /* è¾“å…¥æ¡†ç­‰å®½åº¦åœ¨ç§»åŠ¨ç«¯é“ºæ»¡ */
      .toolbar-left .arco-input-wrapper,
      .toolbar-left .arco-input-group { width: 100% !important; }
      .toolbar-left .arco-input-group .arco-select { width: 35% !important; }
      .toolbar-left .arco-input-group .arco-input-wrapper { width: 65% !important; }
      .toolbar-left > button { flex: 1; }
      .toolbar-right { justify-content: space-between; margin-top: 8px; width: 100%; }

      /* å¼¹çª—åœ¨ç§»åŠ¨ç«¯å®½åº¦é€‚é… */
      .arco-modal {
        width: 95vw !important;
        max-width: 95vw !important;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="main-container">

    <div class="top-toolbar">
      <div class="toolbar-left">
        <a-input
                v-model="searchQuery"
                placeholder="æœç´¢ä¸»æ’­æˆ–é“¾æ¥"
                allow-clear
                style="width: 240px; background-color: rgba(242, 243, 245, 0.8); border: none;">
          <template #prefix><icon-search></icon-search></template>
        </a-input>

        <a-input-group>
          <a-select v-model="form.platform" style="width: 120px; background-color: rgba(242, 243, 245, 0.8); border: none;" placeholder="é€‰æ‹©å¹³å°">
            <a-option value="Douyin">æŠ–éŸ³ (Douyin)</a-option>
            <a-option value="Kuaishou">å¿«æ‰‹ (Kuaishou)</a-option>
            <a-option value="Soop">Soop</a-option>
          </a-select>
          <a-input v-model="form.url" placeholder="ç›´æ’­é—´é“¾æ¥ (http...)" style="width: 300px; background-color: rgba(242, 243, 245, 0.8); border: none;" allow-clear @press-enter="handleAdd"></a-input>
        </a-input-group>

        <a-button type="primary" status="success" @click="handleAdd" :loading="adding">
          <template #icon><icon-plus></icon-plus></template> æ·»åŠ 
        </a-button>

        <a-button type="primary" status="warning" @click="showBatchModal = true">
          <template #icon><icon-copy></icon-copy></template> æ‰¹é‡
        </a-button>

        <div style="display: flex; align-items: center; gap: 8px; background-color: rgba(242, 243, 245, 0.8); padding: 4px 12px; border-radius: 4px; height: 32px; box-sizing: border-box;">
          <span style="font-size: 13px; font-weight: bold; color: #4e5969;">å…¨å±€ç›‘æ§</span>
          <a-switch
                  :model-value="isAllActive"
                  @change="handleMasterSwitch"
                  :disabled="tasks.length === 0"
                  checked-color="#00b42a"
                  unchecked-color="#f53f3f">
            <template #checked>ON</template>
            <template #unchecked>OFF</template>
          </a-switch>
        </div>

        <a-button type="outline" @click="showSettingsModal = true" style="margin-left: auto;">
          <template #icon><icon-settings></icon-settings></template> è®¾ç½®
        </a-button>
      </div>

      <div class="toolbar-right">
        <div class="stat-item" :style="{ color: wsConnected ? '#00b42a' : '#f53f3f' }">
          <span class="status-dot" :class="{ 'is-recording': wsConnected }" :style="{ backgroundColor: wsConnected ? '#00b42a' : '#f53f3f' }"></span>
          {{ wsConnected ? 'å·²è¿æ¥' : 'è¿æ¥ä¸­æ–­' }}
        </div>
        <div class="stat-item">
          <icon-menu></icon-menu> æ€»è®¡: <span class="stat-num">{{ tasks.length }}</span>
        </div>
        <div class="stat-item" style="color: #00b42a;">
          <icon-play-circle></icon-play-circle> ç›‘æ§ä¸­: <span class="stat-num">{{ activeCount }}</span>
        </div>
        <div class="stat-item" style="color: #f53f3f;">
          <icon-record></icon-record> å½“å‰å½•åˆ¶: <span class="stat-num">{{ recordingCount }}</span>
        </div>
      </div>
    </div>

    <a-table :data="paginatedTasks" :pagination="false" :bordered="false" stripe hoverable :scroll="{ x: 800 }" size="small">
      <template #empty>
        <a-empty description="æš‚æ— ç›‘æ§ä»»åŠ¡ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ "></a-empty>
      </template>

      <template #columns>
        <a-table-column title="ä¸»æ’­åŠç”»é¢" data-index="anchor_name" :width="240">
          <template #cell="{ record }">
            <div style="display: flex; align-items: center; gap: 10px;">
              <a-image
                      v-if="record.avatar"
                      :src="record.avatar"
                      width="80"
                      height="45"
                      fit="cover"
                      style="border-radius: 4px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                      alt="ç›´æ’­ç”»é¢"
              >
                <template #error>
                  <div style="width: 80px; height: 45px; background: #f2f3f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #86909c;">
                    å°é¢å¤±æ•ˆ
                  </div>
                </template>
              </a-image>

              <div v-else style="width: 80px; height: 45px; background: #f2f3f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 11px; color: #86909c;">
                æ— ç”»é¢
              </div>

              <div style="display: flex; flex-direction: column; overflow: hidden; max-width: 130px;">
                <span style="font-weight: 600; color: #1d2129; line-height: 1.2; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" :title="record.anchor_name">
                  {{ record.anchor_name }}
                </span>
                <div v-if="record.status === 'åˆå§‹åŒ–ä¸­' || record.anchor_name === record.room_id" style="color: #86909c; font-size: 11px; margin-top: 4px;">
                  <icon-loading></icon-loading> ç­‰å¾…å¼•æ“æŠ“å–...
                </div>
              </div>
            </div>
          </template>
        </a-table-column>

        <a-table-column title="ç›´æ’­é“¾æ¥" :width="180">
          <template #cell="{ record }">
            <a :href="getLiveUrl(record.platform, record.room_id)" target="_blank" class="live-link">
              å‰å¾€ç›´æ’­é—´ <icon-launch style="font-size: 10px;"></icon-launch>
            </a>
          </template>
        </a-table-column>

        <a-table-column title="å½•åˆ¶çŠ¶æ€" :width="220">
          <template #cell="{ record }">
            <div style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
              <span class="status-dot" :class="{ 'is-recording': record.status === 'å½•åˆ¶ä¸­' }"></span>

              <span :style="{ color: record.status === 'å½•åˆ¶ä¸­' ? '#00b42a' : '#86909c' }">
                {{ record.status === 'å½•åˆ¶ä¸­' ? 'æ­£åœ¨å½•åˆ¶' : 'æœªåœ¨å½•åˆ¶' }}
              </span>

              <span v-if="record.status === 'å½•åˆ¶ä¸­'" style="font-size: 11px; color: #86909c;">
                (<span style="color: #165dff;">{{ record.duration }}</span> | <span style="color: #ff7d00;">{{ record.file_size }}</span>)
              </span>
            </div>
          </template>
        </a-table-column>

        <a-table-column title="ç›‘å¬çŠ¶æ€" :width="120">
          <template #cell="{ record }">
            <div style="display: flex; align-items: center; gap: 6px;">
              <a-switch
                      :model-value="!record.is_paused"
                      size="small"
                      :loading="record.switching"
                      @change="(val) => handleSwitch(val, record)">
              </a-switch>
              <span :style="{ fontSize: '12px', color: !record.is_paused ? '#165dff' : '#86909c' }">
                {{ !record.is_paused ? 'ç›‘æ§ä¸­' : 'å·²åœæ­¢' }}
              </span>
            </div>
          </template>
        </a-table-column>

        <a-table-column title="æ“ä½œ" align="center" :width="80">
          <template #cell="{ record }">
            <a-popconfirm content="ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ" type="error" @ok="handleControl('delete', record)">
              <a-button type="text" status="danger" size="mini">
                <template #icon><icon-delete></icon-delete></template> åˆ é™¤
              </a-button>
            </a-popconfirm>
          </template>
        </a-table-column>
      </template>
    </a-table>

    <div style="display: flex; justify-content: flex-end; margin-top: 12px;">
      <a-pagination
              v-model:current="currentPage"
              v-model:page-size="pageSize"
              :total="sortedTasks.length"
              size="small"
              show-total
              show-jumper
              show-page-size>
      </a-pagination>
    </div>
  </div>

  <a-modal v-model:visible="showSettingsModal" title="âš™ï¸ å…¨å±€è®¾ç½®ä¸éªŒè¯" :footer="false" width="600px">
    <a-tabs default-active-key="1">
      <a-tab-pane key="1" title="åŸºç¡€è®¾ç½®">
        <a-form layout="vertical" :model="settings" style="margin-top: 15px;">
          <a-form-item label="å½•åˆ¶ä¿å­˜è·¯å¾„" tooltip="æ”¯æŒç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼Œé»˜è®¤ ./downloads">
            <a-input v-model="settings.save_path" placeholder="./downloads"></a-input>
          </a-form-item>
          <a-form-item label="é»˜è®¤å½•åˆ¶ç”»è´¨">
            <a-select v-model="settings.quality">
              <a-option value="uhd">è“å…‰ / è¶…æ¸… (æœ€é«˜ç”»è´¨)</a-option>
              <a-option value="hd">é«˜æ¸…</a-option>
              <a-option value="sd">æ ‡æ¸…</a-option>
            </a-select>
          </a-form-item>
          <a-form-item label="è‡ªåŠ¨åˆ†ç‰‡æ—¶é•¿ (åˆ†é’Ÿ)" tooltip="è¾¾åˆ°æ—¶é—´åè‡ªåŠ¨åˆ†å‰²è§†é¢‘æ–‡ä»¶ï¼Œ0ä¸ºä¸é™åˆ¶">
            <a-input-number v-model="settings.segment_time" :min="0" :max="1440"></a-input-number>
          </a-form-item>
          <a-button type="primary" status="success" long @click="saveSettings" :loading="saving">ä¿å­˜åŸºç¡€è®¾ç½®</a-button>
        </a-form>
      </a-tab-pane>

      <a-tab-pane key="2" title="å¹³å° Cookie ç®¡ç†">
        <div style="color: #86909c; font-size: 12px; margin: 10px 0 15px;">è‹¥ç¨‹åºä¸€ç›´æ˜¾ç¤ºâ€œç­‰å¾…ä¸­â€æˆ–æŠ¥é”™ï¼Œè¯·æ›´æ–°æ­¤å¤„çš„æµè§ˆå™¨ Cookie è§£é™¤å¹³å°é£æ§ã€‚</div>
        <a-form layout="vertical" :model="cookies">
          <a-form-item label="æŠ–éŸ³ (Douyin) Cookie">
            <a-textarea v-model="cookies.douyin" placeholder="æŠ“å–æŠ–éŸ³ç½‘é¡µç‰ˆ Cookie" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="å¿«æ‰‹ (Kuaishou) Cookie">
            <a-textarea v-model="cookies.kuaishou" placeholder="æŠ“å–å¿«æ‰‹ç½‘é¡µç‰ˆ Cookie (é€‰å¡«)" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-form-item label="Soop Cookie">
            <a-textarea v-model="cookies.soop" placeholder="æŠ“å– Soop ç½‘é¡µç‰ˆ Cookie" allow-clear auto-size></a-textarea>
          </a-form-item>
          <a-button type="primary" status="warning" long @click="saveCookies" :loading="savingCookies">çƒ­æ›´æ–° Cookie</a-button>
        </a-form>
      </a-tab-pane>
    </a-tabs>
  </a-modal>

  <a-modal v-model:visible="showBatchModal" title="ğŸ“‘ æ‰¹é‡æ·»åŠ ç›‘æ§ä»»åŠ¡" @ok="handleBatchAdd" :ok-loading="batchAdding">
    <div style="margin-bottom: 15px;">
      <a-select v-model="batchForm.platform" placeholder="è¯·é€‰æ‹©ç»Ÿä¸€çš„å¹³å°">
        <a-option value="Douyin">æŠ–éŸ³ (Douyin)</a-option>
        <a-option value="Kuaishou">å¿«æ‰‹ (Kuaishou)</a-option>
        <a-option value="Soop">Soop (AfreecaTV)</a-option>
      </a-select>
    </div>
    <a-textarea
            v-model="batchForm.urls"
            placeholder="è¯·è¾“å…¥ç›´æ’­é—´é“¾æ¥æˆ–çº¯æ•°å­—IDï¼Œè¯·ç¡®ä¿ã€ä¸€è¡Œä¸€ä¸ªã€‘&#10;ç¤ºä¾‹ï¼š&#10;https://live.douyin.com/123456&#10;84964967751"
            :auto-size="{minRows: 6, maxRows: 12}">
    </a-textarea>
  </a-modal>
</div>

<script>
  const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;

  const App = {
    setup() {
      const searchQuery = ref('');
      const showSettingsModal = ref(false);
      const showBatchModal = ref(false);

      const currentPage = ref(1);
      const pageSize = ref(10);

      const form = ref({ platform: 'Douyin', url: '' });
      const batchForm = ref({ platform: 'Douyin', urls: '' });
      const settings = ref({ quality: 'uhd', segment_time: 0, save_path: './downloads' });
      const cookies = ref({ douyin: '', kuaishou: '', soop: '' });
      const tasks = ref([]);

      const adding = ref(false);
      const batchAdding = ref(false);
      const saving = ref(false);
      const savingCookies = ref(false);

      const wsConnected = ref(false);
      let ws = null;
      let wsReconnectTimer = null;

      const sortedTasks = computed(() => {
        let list = [...tasks.value];
        if (searchQuery.value) {
          const q = searchQuery.value.toLowerCase();
          list = list.filter(t =>
                  t.anchor_name.toLowerCase().includes(q) ||
                  t.room_id.toLowerCase().includes(q)
          );
        }
        list.sort((a, b) => {
          const isARecording = a.status === 'å½•åˆ¶ä¸­' ? 1 : 0;
          const isBRecording = b.status === 'å½•åˆ¶ä¸­' ? 1 : 0;
          return isBRecording - isARecording;
        });
        return list;
      });

      const paginatedTasks = computed(() => {
        const start = (currentPage.value - 1) * pageSize.value;
        const end = start + pageSize.value;
        return sortedTasks.value.slice(start, end);
      });

      watch(searchQuery, () => {
        currentPage.value = 1;
      });

      const activeCount = computed(() => tasks.value.filter(t => !t.is_paused).length);
      const recordingCount = computed(() => tasks.value.filter(t => t.status === 'å½•åˆ¶ä¸­').length);

      // ã€æ–°å¢ã€‘ï¼šç”¨äºè®¡ç®—å…¨å±€å¼€å…³çŠ¶æ€ã€‚åªè¦å­˜åœ¨ä¸€ä¸ªâ€œæœªæš‚åœâ€çš„ä»»åŠ¡ï¼Œå®ƒå°±äº®èµ·ã€‚
      const isAllActive = computed(() => {
        if (tasks.value.length === 0) return false;
        return tasks.value.some(t => !t.is_paused);
      });

      const getLiveUrl = (platform, roomId) => {
        if (platform === 'Douyin') return `https://live.douyin.com/${roomId}`;
        if (platform === 'Kuaishou') return `https://live.kuaishou.com/u/${roomId}`;
        if (platform === 'Soop') return `https://play.sooplive.co.kr/${roomId}`;
        return roomId;
      };

      const fetchConfigAndCookies = async () => {
        try {
          const res1 = await fetch('/api/config');
          const data1 = await res1.json();
          if (data1) {
            settings.value.quality = data1.quality || 'uhd';
            settings.value.segment_time = data1.segment_time || 0;
            settings.value.save_path = data1.save_path || './downloads';
          }
          const res2 = await fetch('/api/cookies');
          const data2 = await res2.json();
          if (data2) { cookies.value = data2; }
        } catch (e) { console.error("è·å–è®¾ç½®å¤±è´¥", e); }
      };

      const saveSettings = async () => {
        saving.value = true;
        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("åŸºç¡€è®¾ç½®å·²ä¿å­˜ç”Ÿæ•ˆï¼");
            showSettingsModal.value = false;
          }
        } catch (e) { ArcoVue.Message.error("ä¿å­˜å¤±è´¥"); }
        finally { saving.value = false; }
      };

      const saveCookies = async () => {
        savingCookies.value = true;
        try {
          const res = await fetch('/api/cookies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cookies.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("Cookieå·²çƒ­æ›´æ–°ï¼");
          }
        } catch (e) { ArcoVue.Message.error("Cookieæ›´æ–°å¤±è´¥"); }
        finally { savingCookies.value = false; }
      };

      const connectWS = () => {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/status`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          wsConnected.value = true;
          if (wsReconnectTimer) {
            clearInterval(wsReconnectTimer);
            wsReconnectTimer = null;
          }
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);

            const currentSwitching = {};
            tasks.value.forEach(t => {
              if(t.switching) currentSwitching[`${t.platform}_${t.room_id}`] = true;
            });

            tasks.value = (data || []).map(t => ({
              ...t,
              switching: !!currentSwitching[`${t.platform}_${t.room_id}`]
            }));
          } catch (e) {
            console.error("è§£æ WebSocket æ•°æ®å¤±è´¥", e);
          }
        };

        ws.onclose = () => {
          wsConnected.value = false;
          if (!wsReconnectTimer) {
            wsReconnectTimer = setTimeout(connectWS, 3000);
          }
        };

        ws.onerror = (err) => {
          wsConnected.value = false;
          ws.close();
        };
      };

      const handleAdd = async () => {
        if (!form.value.url.trim()) return ArcoVue.Message.warning("è¯·å¡«å†™ç›´æ’­é—´åœ°å€æˆ–ID");
        adding.value = true;
        try {
          const res = await fetch('/api/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(form.value)
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success("ä»»åŠ¡æ·»åŠ æˆåŠŸ");
            form.value.url = '';
          } else {
            ArcoVue.Message.error(data.msg || "æ·»åŠ å¤±è´¥");
          }
        } catch (e) { ArcoVue.Message.error("è¯·æ±‚å¤±è´¥"); }
        finally { adding.value = false; }
      };

      const handleBatchAdd = async (done) => {
        const lines = batchForm.value.urls.split('\n').map(l => l.trim()).filter(l => l !== '');
        if (lines.length === 0) {
          ArcoVue.Message.warning("å†…å®¹ä¸ºç©º");
          done(false); return;
        }
        batchAdding.value = true;
        let success = 0, fail = 0;
        for (const url of lines) {
          try {
            const res = await fetch('/api/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ platform: batchForm.value.platform, url: url })
            });
            const data = await res.json();
            if (data.code === 0) success++; else fail++;
          } catch (e) { fail++; }
        }
        batchAdding.value = false;
        if (fail === 0) {
          ArcoVue.Message.success(`æˆåŠŸæ‰¹é‡æ·»åŠ  ${success} ä¸ªä»»åŠ¡`);
          batchForm.value.urls = '';
          done(true);
        } else {
          ArcoVue.Message.warning(`æ·»åŠ å®Œæˆï¼ŒæˆåŠŸ ${success} ä¸ªï¼Œå¤±è´¥ ${fail} ä¸ª`);
          done(true);
        }
      };

      const handleSwitch = async (checked, record) => {
        record.switching = true;
        const action = checked ? 'resume' : 'pause';

        try {
          await handleControl(action, record);
        } finally {
          record.switching = false;
        }
      };

      const handleControl = async (action, record) => {
        try {
          const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: action,
              platform: record.platform,
              room_id: record.room_id
            })
          });
          const data = await res.json();
          if (data.code === 0) {
            if (action === 'delete') ArcoVue.Message.success("ä»»åŠ¡å·²åˆ é™¤");
            return true;
          } else {
            ArcoVue.Message.error(data.msg || "æ“ä½œå¤±è´¥");
            return false;
          }
        } catch (e) {
          ArcoVue.Message.error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
          return false;
        }
      };

      // ã€æ–°å¢ã€‘ï¼šå…¨å±€ä¸»å¼€å…³æ§åˆ¶ï¼Œæ›¿æ¢åŸå…ˆåˆ†ç¦»çš„æŒ‰é’®
      const handleMasterSwitch = async (val) => {
        const action = val ? 'resume_all' : 'pause_all';
        const actionName = val ? 'å…¨éƒ¨å¼€å¯' : 'å…¨éƒ¨æš‚åœ';
        try {
          const res = await fetch('/api/control_all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
          });
          const data = await res.json();
          if (data.code === 0) {
            ArcoVue.Message.success(`å·²æˆåŠŸæ‰§è¡Œï¼š${actionName}`);
            // ä¹è§‚æ›´æ–°ï¼šåœ¨ç­‰å¾… WebSocket ä¸‹ä¸€æ¬¡æ¨é€å‰ï¼Œä¼˜å…ˆå˜æ›´æœ¬åœ°çŠ¶æ€ä½¿å¾—ç•Œé¢ç«‹é©¬å“åº”
            tasks.value.forEach(t => {
              t.is_paused = !val;
            });
          } else {
            ArcoVue.Message.error(`æ“ä½œå¤±è´¥ï¼š${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
          }
        } catch (e) {
          ArcoVue.Message.error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
        }
      };

      onMounted(() => {
        fetchConfigAndCookies();
        connectWS();
      });

      onUnmounted(() => {
        if (ws) ws.close();
        if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
      });

      return {
        searchQuery, showSettingsModal, showBatchModal,
        currentPage, pageSize, sortedTasks, paginatedTasks,
        form, batchForm, settings, cookies, tasks, wsConnected,
        activeCount, recordingCount, adding, batchAdding, saving, savingCookies,
        isAllActive, // å¯¼å‡ºå…¨å±€çŠ¶æ€å˜é‡
        getLiveUrl, handleAdd, handleBatchAdd, saveSettings, saveCookies, handleControl, handleSwitch, handleMasterSwitch
      };
    }
  };

  const app = createApp(App);
  app.use(ArcoVue);
  app.use(ArcoVueIcon);
  app.mount('#app');
</script>
</body>
</html>